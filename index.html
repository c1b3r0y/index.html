<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardar, Editar y Mostrar Foto</title>
    <link rel="stylesheet" href="styles.css"> <!-- Enlace al CSS -->
</head>
<body>
    <h1>Guardar Nombre, Descripción y Foto</h1>
    <form id="dataForm">
        <label for="name">Nombre:</label>
        <input type="text" id="name" required>
        <br><br>
        <label for="description">Descripción:</label>
        <textarea id="description" rows="4" cols="50" required></textarea>
        <br><br>
        <label for="photo">Foto:</label>
        <input type="file" id="photo" accept="image/*">
        <br><br>
        <button type="submit">Guardar</button>
    </form>

    <h2>Información Guardada</h2>
    <div id="savedData">
        <!-- Aquí se mostrarán los datos guardados -->
    </div>

    <script type="module">
        // Importar Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCAT6ZJsrI8tlyiDc1dEBSiezdK_JuEBmg",
            authDomain: "inventario-2be27.firebaseapp.com",
            projectId: "inventario-2be27",
            storageBucket: "inventario-2be27.appspot.com",
            messagingSenderId: "138347129495",
            appId: "1:138347129495:web:c31aab61624d1a68bcd7d2"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        const savedDataDiv = document.getElementById('savedData');

        // Función para agregar datos al DOM
        const addDataToSection = (id, name, description, photoURL) => {
            const div = document.createElement('div');
            div.className = 'entry';
            div.id = id;

            let photoHtml = '';
            if (photoURL) {
                photoHtml = `<img src="${photoURL}" alt="Foto de ${name}" class="entry-photo">`;
            }

            div.innerHTML = `
                <h3 class="entry-title">${name}</h3>
                <p class="entry-description">${description}</p>
                ${photoHtml}
                <div class="entry-buttons">
                    <button onclick="editEntry('${id}', '${name}', '${description}')">Editar</button>
                    <button onclick="deleteEntry('${id}')">Eliminar</button>
                </div>
            `;
            savedDataDiv.appendChild(div);
        };

        // Cargar datos al abrir la página
        const dbRef = ref(database, 'entries');
        onValue(dbRef, (snapshot) => {
            savedDataDiv.innerHTML = ""; // Limpia los datos previos
            const data = snapshot.val();
            if (data) {
                Object.entries(data).forEach(([id, entry]) => {
                    addDataToSection(id, entry.name, entry.description, entry.photoURL);
                });
            }
        });

        // Manejo del formulario
        const form = document.getElementById('dataForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('name').value;
            const description = document.getElementById('description').value;
            const photo = document.getElementById('photo').files[0];

            let photoURL = null;
            if (photo) {
                try {
                    const storagePath = `photos/${Date.now()}_${photo.name}`;
                    const photoRef = storageRef(storage, storagePath);
                    const snapshot = await uploadBytes(photoRef, photo);
                    photoURL = await getDownloadURL(snapshot.ref);
                } catch (error) {
                    console.error("Error al cargar la foto:", error);
                    alert("Hubo un problema al cargar la foto.");
                    return;
                }
            }

            const newEntryRef = push(dbRef);

            set(newEntryRef, {
                name,
                description,
                photoURL,
                timestamp: new Date().toISOString()
            })
            .then(() => {
                alert('Datos guardados correctamente');
                form.reset();
            })
            .catch((error) => {
                console.error('Error al guardar:', error);
                alert('Hubo un error al guardar los datos.');
            });
        });
    </script>
</body>
</html>
