<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <link rel="stylesheet" href="styles.css"> 
    <title>Guardar, Editar, Eliminar y Cargar Fotos</title>
</head>
<body>
    <h1>Guardar Nombre, Descripción y Foto</h1>
    <form id="dataForm">
        <label for="name">Nombre:</label>
        <input type="text" id="name" required>
        <br><br>
        <label for="description">Descripción:</label>
        <textarea id="description" rows="4" cols="50" required></textarea>
        <br><br>
        <label for="photo">Foto:</label>
        <input type="file" id="photo" accept="image/*">
        <br><br>
        <div id="preview" style="display: none; margin-bottom: 10px;">
            <p><strong>Vista previa:</strong></p>
            <img id="previewImage" src="" alt="Vista previa de la foto" style="max-width: 200px; border: 1px solid #ddd;">
        </div>
        <button type="submit">Guardar</button>
    </form>

    <h2>Información Guardada</h2>
    <div id="savedData">
        <!-- Aquí se mostrarán los datos ingresados y guardados -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCAT6ZJsrI8tlyiDc1dEBSiezdK_JuEBmg",
            authDomain: "inventario-2be27.firebaseapp.com",
            projectId: "inventario-2be27",
            storageBucket: "inventario-2be27.appspot.com",
            messagingSenderId: "138347129495",
            appId: "1:138347129495:web:c31aab61624d1a68bcd7d2",
            measurementId: "G-DL44WCPP4L"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        const savedDataDiv = document.getElementById('savedData');
        const photoInput = document.getElementById('photo');
        const previewDiv = document.getElementById('preview');
        const previewImage = document.getElementById('previewImage');

        // Mostrar vista previa de la foto seleccionada
        photoInput.addEventListener('change', () => {
            const file = photoInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewDiv.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewImage.src = '';
                previewDiv.style.display = 'none';
            }
        });

        // Función para agregar datos al DOM con botones de editar, eliminar y vista previa
        const addDataToSection = (id, name, description, photoURL) => {
            const div = document.createElement('div');
            div.id = id;
            div.style.border = "1px solid #ddd";
            div.style.padding = "10px";
            div.style.marginBottom = "10px";

            let photoHtml = "";
            if (photoURL) {
                photoHtml = `<img src="${photoURL}" alt="Foto de ${name}" width="200" style="margin-top:10px;">`;
            }

            div.innerHTML = `
                <h3>${name}</h3>
                <p>${description}</p>
                <div style="margin-top:10px;">
                    <button class="edit-btn" data-id="${id}" data-name="${name}" data-description="${description}">Editar</button>
                    <button class="delete-btn" data-id="${id}">Eliminar</button>
                </div>
                <div style="margin-top:10px;">
                    <p><strong>Vista previa guardada:</strong></p>
                    ${photoHtml}
                </div>
            `;
            savedDataDiv.appendChild(div);
        };

        // Cargar todos los datos al abrir la página
        const dbRef = ref(database, 'entries');
        onValue(dbRef, (snapshot) => {
            savedDataDiv.innerHTML = ""; // Limpia los datos previos
            const data = snapshot.val();
            if (data) {
                Object.entries(data).forEach(([id, entry]) => {
                    addDataToSection(id, entry.name, entry.description, entry.photoURL);
                });

                // Conectar eventos a los botones después de cargar los datos
                connectButtonEvents();
            }
        });

        // Manejo del formulario
        const form = document.getElementById('dataForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('name').value;
            const description = document.getElementById('description').value;
            const photo = document.getElementById('photo').files[0];

            let photoURL = null;
            if (photo) {
                const storagePath = `photos/${Date.now()}_${photo.name}`;
                const photoRef = storageRef(storage, storagePath);
                const snapshot = await uploadBytes(photoRef, photo);
                photoURL = await getDownloadURL(snapshot.ref);
            }

            const newEntryRef = push(dbRef);

            set(newEntryRef, {
                name: name,
                description: description,
                photoURL: photoURL,
                timestamp: new Date().toISOString()
            })
            .then(() => {
                alert('Datos guardados correctamente');
                form.reset();
                previewImage.src = '';
                previewDiv.style.display = 'none';
            })
            .catch((error) => {
                console.error('Error al guardar:', error);
                alert('Hubo un error al guardar los datos.');
            });
        });

        // Conectar eventos a los botones de editar y eliminar
        const connectButtonEvents = () => {
            const editButtons = document.querySelectorAll('.edit-btn');
            const deleteButtons = document.querySelectorAll('.delete-btn');

            editButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const name = e.target.dataset.name;
                    const description = e.target.dataset.description;
                    editEntry(id, name, description);
                });
            });

            deleteButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    deleteEntry(id);
                });
            });
        };

        // Función para editar datos
        const editEntry = (id, name, description) => {
            const newName = prompt("Editar nombre:", name);
            const newDescription = prompt("Editar descripción:", description);

            if (newName && newDescription) {
                const entryRef = ref(database, `entries/${id}`);
                update(entryRef, {
                    name: newName,
                    description: newDescription
                })
                .then(() => alert('Datos actualizados correctamente'))
                .catch((error) => console.error('Error al actualizar:', error));
            }
        };

        // Función para eliminar datos
        const deleteEntry = (id) => {
            if (confirm("¿Estás seguro de que deseas eliminar esta entrada?")) {
                const entryRef = ref(database, `entries/${id}`);
                remove(entryRef)
                .then(() => {
                    document.getElementById(id).remove();
                    alert('Datos eliminados correctamente');
                })
                .catch((error) => console.error('Error al eliminar:', error));
            }
        };
    </script>
</body>
</html>
