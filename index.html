<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardar, Editar, Eliminar y Cargar Fotos</title>
</head>
<body>
    <h1>Guardar Nombre, Descripción y Foto</h1>
    <form id="dataForm">
        <label for="name">Nombre:</label>
        <input type="text" id="name" required>
        <br><br>
        <label for="description">Descripción:</label>
        <textarea id="description" rows="4" cols="50" required></textarea>
        <br><br>
        <label for="photo">Foto:</label>
        <input type="file" id="photo" accept="image/*">
        <br><br>
        <button type="submit">Guardar</button>
    </form>

    <h2>Información Guardada</h2>
    <div id="savedData">
        <!-- Aquí se mostrarán los datos ingresados y guardados -->
    </div>

    <script type="module">
        // Importar Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCAT6ZJsrI8tlyiDc1dEBSiezdK_JuEBmg",
            authDomain: "inventario-2be27.firebaseapp.com",
            projectId: "inventario-2be27",
            storageBucket: "inventario-2be27.appspot.com",
            messagingSenderId: "138347129495",
            appId: "1:138347129495:web:c31aab61624d1a68bcd7d2",
            measurementId: "G-DL44WCPP4L"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        const savedDataDiv = document.getElementById('savedData');

        // Función para agregar datos al DOM con botones de editar y eliminar
        const addDataToSection = (id, name, description, photoURL) => {
            const div = document.createElement('div');
            div.id = id;
            div.style.border = "1px solid #ddd";
            div.style.padding = "10px";
            div.style.marginBottom = "10px";

            let photoHtml = "";
            if (photoURL) {
                photoHtml = `<br><img src="${photoURL}" alt="Foto de ${name}" width="200" style="margin-top:10px;">`;
            }

            div.innerHTML = `
                <strong>${name}</strong>: ${description}
                ${photoHtml}
                <div style="margin-top:10px;">
                    <button onclick="editEntry('${id}', '${name}', '${description}')">Editar</button>
                    <button onclick="deleteEntry('${id}')">Eliminar</button>
                </div>
            `;
            savedDataDiv.appendChild(div);
        };

        // Cargar todos los datos al abrir la página
        const dbRef = ref(database, 'entries');
        onValue(dbRef, (snapshot) => {
            savedDataDiv.innerHTML = ""; // Limpia los datos previos
            const data = snapshot.val();
            if (data) {
                Object.entries(data).forEach(([id, entry]) => {
                    addDataToSection(id, entry.name, entry.description, entry.photoURL);
                });
            }
        });

        // Manejo del formulario
        const form = document.getElementById('dataForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('name').value;
            const description = document.getElementById('description').value;
            const photo = document.getElementById('photo').files[0];

            let photoURL = null;
            if (photo) {
                const storagePath = `photos/${Date.now()}_${photo.name}`;
                const photoRef = storageRef(storage, storagePath);
                const snapshot = await uploadBytes(photoRef, photo);
                photoURL = await getDownloadURL(snapshot.ref);
            }

            const newEntryRef = push(dbRef);

            set(newEntryRef, {
                name: name,
                description: description,
                photoURL: photoURL,
                timestamp: new Date().toISOString()
            })
            .then(() => {
                alert('Datos guardados correctamente');
                form.reset();
            })
            .catch((error) => {
                console.error('Error al guardar:', error);
                alert('Hubo un error al guardar los datos.');
            });
        });

        // Función para editar datos
        window.editEntry = (id, name, description) => {
            const newName = prompt("Editar nombre:", name);
            const newDescription = prompt("Editar descripción:", description);

            if (newName && newDescription) {
                const entryRef = ref(database, `entries/${id}`);
                update(entryRef, {
                    name: newName,
                    description: newDescription
                })
                .then(() => alert('Datos actualizados correctamente'))
                .catch((error) => console.error('Error al actualizar:', error));
            }
        };

        // Función para eliminar datos
        window.deleteEntry = (id) => {
            if (confirm("¿Estás seguro de que deseas eliminar esta entrada?")) {
                const entryRef = ref(database, `entries/${id}`);
                remove(entryRef)
                .then(() => {
                    document.getElementById(id).remove();
                    alert('Datos eliminados correctamente');
                })
                .catch((error) => console.error('Error al eliminar:', error));
            }
        };
    </script>
</body>
</html>
